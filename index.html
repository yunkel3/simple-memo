<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>„Ç∑„É≥„Éó„É´„É°„É¢Â∏≥</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    html, body {
      touch-action: manipulation;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fff;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    body.dark-mode {
      background-color: #333;
      color: #eee;
    }
    h1 {
      font-size: 2em;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      margin: 0;
      min-height: 3em;
      padding: 10px;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      overflow-y: hidden;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      color: #333;
      flex-grow: 1;
    }
    body.dark-mode textarea {
      background-color: #555;
      color: #eee;
      border-color: #777;
    }
    .textarea-container {
      width: 100%;
      flex-grow: 1;
      display: flex;
    }
    .button-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 0;
      margin-top: 10px;
      padding: 0;
      width: 100%;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      box-sizing: border-box;
    }
    body.dark-mode .button-container {
      border-color: #888;
    }
    button {
      padding: 10px 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-left: 1px solid #ccc;
      border-radius: 0 !important;
      background-color: #f0f0f0;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
      flex-shrink: 1;
      flex-basis: 0;
      box-sizing: border-box;
      white-space: nowrap;
      touch-action: manipulation;
      transition: opacity 0.2s;
    }
    body.dark-mode button {
      background-color: #666;
      color: #eee;
      border-color: #888;
    }
    .button-container button:first-child {
      border-left: none;
    }
    .material-symbols-outlined {
      font-size: 20px;
      margin-right: 5px;
      vertical-align: middle;
    }
    button#copyButton .material-symbols-outlined {
      margin-right: 0;
    }
    .button-container button {
      min-width: fit-content;
    }
    .disabled {
      opacity: 0.4;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>üìù</h1>
  <div class="textarea-container">
    <textarea id="memo" placeholder="„Åì„Åì„Å´„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." oninput="handleInput()" onkeydown="handleKeydown(event)" onblur="saveState()" onfocus="saveState()"></textarea>
  </div>
  <div class="button-container">
    <button class="theme" onclick="toggleDarkMode()">
      <span class="material-symbols-outlined" id="darkModeIcon">light_mode</span>
    </button>
    <button class="clear" id="clearButton" onclick="clearText()">
      <span class="material-symbols-outlined">delete</span>
    </button>
    <button id="copyButton" onclick="copyText()">„Ç≥„Éî„Éº</button>
    <button id="undoButton" onclick="undo()">Êàª„Çã</button>
    <button id="redoButton" onclick="redo()">ÈÄ≤„ÇÄ</button>
  </div>

  <script>
    const textarea = document.getElementById('memo');
    const copyBtn = document.getElementById('copyButton');
    const clearBtn = document.getElementById('clearButton');
    const undoBtn = document.getElementById('undoButton');
    const redoBtn = document.getElementById('redoButton');
    let undoStack = [];
    let redoStack = [];
    let lastSavedText = '';

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
      textarea.value = localStorage.getItem('memo') || '';
      lastSavedText = textarea.value;
      adjustHeight(textarea);
      updateDarkModeIcon();
      updateButtonStates();
    });

    textarea.addEventListener('compositionend', () => {
      saveState();
      updateButtonStates();
    });

    function adjustHeight(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }

    function copyText() {
      if (!textarea.value.trim()) return;
      navigator.clipboard.writeText(textarea.value).catch(err => {
        alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + err);
      });
    }

    function clearText() {
      if (!textarea.value) return;
      saveState();
      textarea.value = '';
      adjustHeight(textarea);
      updateButtonStates();
    }

    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
      updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
      const icon = document.getElementById('darkModeIcon');
      icon.textContent = document.body.classList.contains('dark-mode') ? 'dark_mode' : 'light_mode';
    }

    function saveState() {
      const current = textarea.value;
      if (current !== lastSavedText) {
        undoStack.push(lastSavedText);
        lastSavedText = current;
        redoStack = [];
        localStorage.setItem('memo', current);
        updateButtonStates();
      }
    }

    function handleInput() {
      adjustHeight(textarea);
      localStorage.setItem('memo', textarea.value);
      updateButtonStates();
    }

    function handleKeydown(event) {
      const key = event.key;
      if (key === ' ' || key === 'Enter') {
        saveState();
      } else if (key === 'Backspace') {
        const now = textarea.value;
        if (lastSavedText.length - now.length >= 2) {
          saveState();
        }
      }
    }

    function undo() {
      if (undoStack.length > 0) {
        redoStack.push(textarea.value);
        const prev = undoStack.pop();
        textarea.value = prev;
        lastSavedText = prev;
        adjustHeight(textarea);
        localStorage.setItem('memo', prev);
        updateButtonStates();
      }
    }

    function redo() {
      if (redoStack.length > 0) {
        undoStack.push(textarea.value);
        const next = redoStack.pop();
        textarea.value = next;
        lastSavedText = next;
        adjustHeight(textarea);
        localStorage.setItem('memo', next);
        updateButtonStates();
      }
    }

    function updateButtonStates() {
      copyBtn.classList.toggle('disabled', !textarea.value.trim());
      clearBtn.classList.toggle('disabled', !textarea.value);
      undoBtn.classList.toggle('disabled', undoStack.length === 0);
      redoBtn.classList.toggle('disabled', redoStack.length === 0);
    }
  </script>
</body>
</html>